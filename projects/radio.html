<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Radio</title>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <link rel="stylesheet" href="../css/style.css">

    <style>
        :root {
            --bg-color: #050505;
            --holo-primary: #00ff9d; 
            --holo-dim: rgba(0, 255, 157, 0.1);
            --holo-accent: #ff80ab;
            --static-color: rgba(255, 255, 255, 0.15);
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            color: var(--holo-primary);
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #static-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzAwMCIvPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIGZpbHRlcj0idXJsKCNub2lzZSkiLz48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48L3N2Zz4=');
            opacity: 0.8;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.2s ease;
        }

        .tuner-casing {
            position: relative;
            width: 90%;
            max-width: 800px;
            background: rgba(10, 12, 10, 0.9);
            border: 1px solid #333;
            border-top: 2px solid var(--holo-primary);
            box-shadow: 0 0 50px rgba(0, 255, 157, 0.05);
            padding: 2rem;
            z-index: 20;
            backdrop-filter: blur(10px);
        }

        .freq-display {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        #current-freq {
            font-size: 5rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 20px var(--holo-primary);
            letter-spacing: -2px;
        }

        #station-name {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            color: var(--holo-accent);
            height: 1.5rem;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #track-info {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
            height: 1rem;
        }

        canvas#visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #333;
            margin-bottom: 2rem;
        }

        .dial-container {
            position: relative;
            width: 100%;
            height: 80px;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
            cursor: grab;
        }
        .dial-container:active { cursor: grabbing; }

        .dial-ticks {
            position: absolute;
            top: 0; left: 0;
            height: 100%;
            display: flex;
            align-items: flex-end;
            padding-bottom: 20px;
        }

        .tick {
            width: 2px;
            background: #444;
            margin-right: 15px; 
            flex-shrink: 0;
            position: relative;
        }
        .tick.major { height: 40px; background: #888; }
        .tick.minor { height: 20px; }
        
        .tick-label {
            position: absolute;
            top: -25px; left: -15px;
            width: 30px;
            text-align: center;
            font-size: 0.7rem;
            color: #666;
        }

        .needle {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--holo-accent);
            box-shadow: 0 0 10px var(--holo-accent);
            z-index: 5;
            pointer-events: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 2rem;
        }

        .ctrl-btn {
            background: transparent;
            border: 1px solid #333;
            color: #666;
            width: 50px; height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .ctrl-btn:hover {
            color: var(--holo-primary);
            border-color: var(--holo-primary);
            box-shadow: 0 0 15px var(--holo-dim);
        }
        .ctrl-btn.active {
            color: #000;
            background: var(--holo-primary);
            box-shadow: 0 0 20px var(--holo-primary);
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 150px;
            height: 4px;
            background: #333;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: var(--holo-primary);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--holo-primary);
        }

        @keyframes glitch-text {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        .locked-glitch { animation: glitch-text 0.3s infinite; color: var(--holo-primary) !important; }

        .back-link {
            position: absolute;
            bottom: 20px;
            color: #444;
            text-decoration: none;
            font-size: 0.8rem;
            text-transform: uppercase;
            transition: 0.3s;
            z-index: 100;
        }
        .back-link:hover { color: var(--holo-primary); }
    </style>
</head>
<body>

    <div id="static-overlay"></div>

    <div class="tuner-casing">
        
        <div class="freq-display">
            <div style="font-size: 0.8rem; color: #666; letter-spacing: 4px; margin-bottom: 5px;">FM RADIO</div>
            <div id="current-freq">88.0</div>
            <div id="station-name">SEARCHING...</div>
            <div id="track-info"></div>
        </div>

        <canvas id="visualizer"></canvas>

        <div class="dial-container" id="dial">
            <div class="dial-ticks" id="ticks"></div>
            <div class="needle"></div>
        </div>

        <div class="controls">
            <button class="ctrl-btn" id="mute-btn" title="Mute Audio"><i class="fas fa-volume-up"></i></button>
            <i class="fas fa-volume-down" style="color: #444; font-size: 0.8rem;"></i>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5">
            <i class="fas fa-volume-up" style="color: #444; font-size: 0.8rem;"></i>
        </div>

    </div>

    <a href="../projects/index.html" class="back-link">[ Return to Projects ]</a>

    <script>
        const STATIONS = [
            { 
                freq: 88.5, 
                name: "MÅNESKIN",
                playlist: [
                    { file: "maneskin1.mp3", duration: 173, title: "I WANNA BE YOUR SLAVE" }, 
                    { file: "maneskin2.mp3", duration: 191, title: "OWN MY MIND" }
                ]
            },
            { 
                freq: 92.4, 
                name: "SYSTEM OF A DOWN", 
                playlist: [
                    { file: "soad1.mp3", duration: 212, title: "VIOLENT PORNOGRAPHY" },
                    { file: "soad2.mp3", duration: 206, title: "CHOP SUEY!" }
                ]
            },
            { 
                freq: 98.0, 
                name: "ARCTIC MONKEYS", 
                playlist: [
                    { file: "am1.mp3", duration: 191, title: "THIS HOUSE IS A CIRCUS" },
                    { file: "am2.mp3", duration: 145, title: "THE BAD THING" }
                ]
            },
            { 
                freq: 104.5, 
                name: "ISSBROKIE", 
                playlist: [
                    { file: "issbrokie1.mp3", duration: 111, title: "PUFF!" },
                    { file: "issbrokie2.mp3", duration: 98, title: "OPPER STOPPER" },
                    { file: "issbrokie3.mp3", duration: 114, title: "HM, YEAH OKAY BUD!" }
                ]
            },
            { 
                freq: 107.0, 
                name: "GABE ❤️", 
                playlist: [
                    { file: "gabe1.mp3", duration: 225, title: "CULTS - ALWAYS FOREVER" }
                ]
            }
        ];

        let currentFreq = 88.0;
        let isDragging = false;
        let startX = 0;
        let startFreq = 88.0;
        
        let audioCtx, masterGain, staticGain, staticNode, analyser, sourceNode;
        let isMuted = false;
        let masterVolume = 0.5;
        let activeAudio = new Audio();
        
        let currentStation = null;
        let signalQuality = 0;

        const dial = document.getElementById('dial');
        const ticks = document.getElementById('ticks');
        const freqDisplay = document.getElementById('current-freq');
        const nameDisplay = document.getElementById('station-name');
        const trackDisplay = document.getElementById('track-info');
        const staticOverlay = document.getElementById('static-overlay');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const muteBtn = document.getElementById('mute-btn');
        const volSlider = document.getElementById('volume-slider');

        function initDial() {
            for (let f = 87; f <= 109; f++) {
                const tick = document.createElement('div');
                tick.className = 'tick major';
                tick.innerHTML = `<span class="tick-label">${f}</span>`;
                ticks.appendChild(tick);
                for(let j=0; j<4; j++) {
                    ticks.appendChild(document.createElement('div')).className = 'tick minor';
                }
            }
            updateDialPosition();
        }

        function initAudio() {
            if (audioCtx) return;
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            masterGain = audioCtx.createGain();
            masterGain.gain.value = masterVolume;
            masterGain.connect(audioCtx.destination);

            const bufferSize = 2 * audioCtx.sampleRate;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            staticNode = audioCtx.createBufferSource();
            staticNode.buffer = buffer;
            staticNode.loop = true;
            
            staticGain = audioCtx.createGain();
            staticGain.gain.value = 0.15; 

            staticNode.connect(staticGain);
            staticGain.connect(masterGain);
            staticNode.start();

            if (window.location.protocol !== 'file:') {
                try {
                    sourceNode = audioCtx.createMediaElementSource(activeAudio);
                    analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 64; 
                    sourceNode.connect(analyser);
                    analyser.connect(masterGain);
                } catch (e) {
                    console.log(e);
                }
            }
            
            drawVisualizer();
        }

        function getSyncedTrack(station) {
            const now = Math.floor(Date.now() / 1000); 
            const totalDuration = station.playlist.reduce((acc, track) => acc + track.duration, 0);
            let loopTime = now % totalDuration;
            let currentOffset = 0;
            
            for (let i = 0; i < station.playlist.length; i++) {
                const track = station.playlist[i];
                if (loopTime < currentOffset + track.duration) {
                    return {
                        seekTime: loopTime - currentOffset,
                        trackData: track
                    };
                }
                currentOffset += track.duration;
            }
            return null; 
        }

        function updateTuner() {
            if (!audioCtx) return;

            let bestStation = null;
            let minDiff = 100;

            STATIONS.forEach(station => {
                const diff = Math.abs(station.freq - currentFreq);
                if (diff < minDiff) {
                    minDiff = diff;
                    bestStation = station;
                }
            });

            if (minDiff < 0.4) {
                signalQuality = 1 - (minDiff / 0.4); 
                
                if(staticGain) staticGain.gain.value = (1 - signalQuality) * 0.15 * (isMuted ? 0 : masterVolume);
                staticOverlay.style.opacity = (1 - signalQuality) * 0.8;
                
                if (currentStation !== bestStation) {
                    currentStation = bestStation;
                    playSyncedTrack(bestStation);
                } else {
                    if (activeAudio.paused && signalQuality > 0.1) {
                        playSyncedTrack(bestStation);
                    }
                }
                
                activeAudio.volume = signalQuality * (isMuted ? 0 : masterVolume);

                if (signalQuality > 0.8) {
                    nameDisplay.innerText = bestStation.name;
                    nameDisplay.style.opacity = 1;
                    nameDisplay.classList.add('locked-glitch');
                    freqDisplay.style.color = "#fff";
                    
                    const syncData = getSyncedTrack(bestStation);
                    if(syncData) trackDisplay.innerText = "NOW PLAYING: " + syncData.trackData.title;
                    
                } else {
                    nameDisplay.innerText = "TUNING...";
                    nameDisplay.style.opacity = signalQuality;
                    nameDisplay.classList.remove('locked-glitch');
                    freqDisplay.style.color = `rgba(255,255,255, ${0.5 + signalQuality/2})`;
                    trackDisplay.innerText = "";
                }

            } else {
                signalQuality = 0;
                if(staticGain) staticGain.gain.value = 0.15 * (isMuted ? 0 : masterVolume);
                staticOverlay.style.opacity = 0.8;
                
                if (!activeAudio.paused) {
                    activeAudio.pause();
                    currentStation = null;
                }
                
                nameDisplay.style.opacity = 0;
                freqDisplay.style.color = "rgba(255,255,255,0.5)";
                trackDisplay.innerText = "";
            }
        }

        function playSyncedTrack(station) {
            const syncData = getSyncedTrack(station);
            const trackPath = "../audio/" + syncData.trackData.file; 

            if (activeAudio.src.indexOf(syncData.trackData.file) === -1) {
                activeAudio.src = trackPath;
                activeAudio.currentTime = syncData.seekTime;
                activeAudio.play().catch(e => {});
            } else {
                if (Math.abs(activeAudio.currentTime - syncData.seekTime) > 2) {
                    activeAudio.currentTime = syncData.seekTime;
                }
                if (activeAudio.paused) activeAudio.play();
            }
        }

        dial.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.pageX;
            startFreq = currentFreq;
            if(!audioCtx) initAudio(); 
        });

        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const delta = (startX - e.pageX) / 20; 
            let newFreq = startFreq + delta;
            newFreq = Math.max(87.0, Math.min(109.0, newFreq));
            currentFreq = Math.round(newFreq * 10) / 10;
            freqDisplay.innerText = currentFreq.toFixed(1);
            updateDialPosition();
            updateTuner();
        });

        muteBtn.addEventListener('click', () => {
            if(!audioCtx) initAudio();
            isMuted = !isMuted;
            
            if(isMuted) {
                masterGain.gain.value = 0;
                activeAudio.volume = 0;
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                muteBtn.classList.add('active');
            } else {
                masterGain.gain.value = masterVolume;
                activeAudio.volume = signalQuality * masterVolume;
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                muteBtn.classList.remove('active');
            }
        });

        volSlider.addEventListener('input', (e) => {
            masterVolume = parseFloat(e.target.value);
            if(audioCtx && !isMuted) {
                masterGain.gain.value = masterVolume;
                activeAudio.volume = signalQuality * masterVolume;
            }
        });

        function updateDialPosition() {
            const percent = (currentFreq - 87) / (109 - 87);
            const containerWidth = dial.offsetWidth;
            const offset = -(percent * 1800) + (containerWidth / 2); 
            ticks.style.transform = `translateX(${offset}px)`;
        }

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!audioCtx) return;

            const bars = 40;
            const step = canvas.width / bars;
            let dataArray = null;

            if(analyser) {
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);
            }

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--holo-primary');

            for (let i = 0; i < bars; i++) {
                let barHeight = 0;

                const staticHeight = Math.random() * 20 * (1 - signalQuality);
                
                let musicHeight = 0;
                if (signalQuality > 0.1) {
                    let hasRealData = dataArray && dataArray.some(x => x > 0);
                    
                    if (hasRealData) {
                        const index = Math.floor((i / bars) * dataArray.length);
                        musicHeight = (dataArray[index] / 255) * canvas.height * signalQuality;
                    } else {
                        const time = Date.now() / 200;
                        musicHeight = (Math.sin(i * 0.5 + time) + 1) * 15 * signalQuality; 
                    }
                }

                barHeight = staticHeight + musicHeight;
                ctx.fillRect(i * step, (canvas.height - barHeight)/2, step - 2, barHeight);
            }
        }

        initDial();
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        setInterval(() => {
            if(audioCtx && currentStation) updateTuner();
        }, 1000);

    </script>
</body>
</html>